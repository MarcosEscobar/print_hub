<%= form_for(@print) do |f| %>
  <% if @print.new_record? %>
    <%= content_for :js_extra do %>
      <%= raw "var print_job='#{generate_template(f, :print_jobs,
        locals: { disabled: false })}';" %>
      <%= raw "var article_line='#{generate_template(f, :article_lines,
        locals: { disabled: false })}';" %>
    <% end %>
  <% end %>
  <%= show_error_messages(@print) %>

  <div class="field column_left">
    <%= f.label :printer %>
    <%= print_destinations_field(f) %>
  </div>
  <div class="field column_left">
    <%= f.label :customer, raw(Print.human_attribute_name(:customer) + ' ' + link_to_customer_credit_detail(@print.customer)), for: :print_auto_customer_name %>
    <% field_classes = [:autocomplete_field] %>
    <% field_classes << :field_with_errors unless @print.errors[:customer_id].blank? %>
    <%= f.text_field :auto_customer_name, value: @print.customer,
      class: field_classes.join(' '),
      'data-autocomplete-url' => autocomplete_for_customer_name_prints_path %>
    <% if @print.customer %>
      <%= link_to_function 'X', "Print.clearCustomer(); $(this).remove()",
        class: 'remove' %>
    <% end %>
    <%= f.hidden_field :customer_id, class: 'autocomplete_id' %>
    <%= hidden_field_tag :customer_free_credit,
      @print.customer.try(:free_credit), id: 'customer_free_credit' %>
  </div>

  <div class="clear">
    <div class="field column_left">
      <%= f.label :scheduled_at %>
      <%= calendar_text_field f, :scheduled_at, time: true %>
    </div>
    <div class="field column_left" style="width: 24%;">
      <%= f.label :avoid_printing %>
      <%= f.check_box :avoid_printing %>
    </div>
    <div class="field column_left" style="width: 24%;">
      <%= f.label :pay_later %>
      <%= f.check_box :pay_later %>
    </div>
  </div>

  <section class="nested_items">
    <h2><%= t 'view.prints.print_jobs' %></h2>
    
    <div id="print_jobs_headers" class="headers">
      <h3><%= PrintJob.human_attribute_name :document_id %></h3>
      <h3><%= PrintJob.human_attribute_name :copies %></h3>
      <h3><%= PrintJob.human_attribute_name :pages %></h3>
      <h3><%= PrintJob.human_attribute_name :price_per_copy %></h3>
      <h3><%= PrintJob.human_attribute_name :range %></h3>
      <h3><%= PrintJob.human_attribute_name :two_sided %></h3>
      <br class="break" />
    </div>
    
    <div id="print_jobs" class="items">
      <% @print.print_jobs.build if @print.print_jobs.empty? %>
      <%= f.fields_for :print_jobs do |pj_f| %>
        <%= render partial: 'print_job', locals: {
          f: pj_f, is_dynamic: false, disabled: !@print.new_record?
        } %>
      <% end %>
    </div>
  </section>

  <div class="add_nested_item">
    <%= link_to_if @print.new_record?, t('view.prints.add_print_job'), '#',
      'data-template' => 'print_job', 'data-container' => '#print_jobs',
      'data-event' => 'addNestedItem', id: 'add_print_job_link',
      title: t('view.prints.add_print_job_title') %>
  </div>

  <section class="nested_items">
    <h2><%= t 'view.prints.article_lines' %></h2>

    <div id="article_lines_headers" class="headers">
      <h3><%= ArticleLine.human_attribute_name :article_id %></h3>
      <h3><%= ArticleLine.human_attribute_name :units %></h3>
      <h3><%= ArticleLine.human_attribute_name :unit_price %></h3>
      <br class="break" />
    </div>

    <div id="article_lines" class="items">
      <% @print.article_lines.build if @print.article_lines.empty? %>
      <%= f.fields_for :article_lines do |pj_f| %>
        <%= render partial: 'article_line', locals: {
          f: pj_f, is_dynamic: false, disabled: !@print.new_record?
        } %>
      <% end %>
    </div>
  </section>

  <div class="add_nested_item">
    <%= link_to_if @print.new_record?, t('view.prints.add_article_line'), '#',
      'data-template' => 'article_line', 'data-container' => '#article_lines',
      'data-event' => 'addNestedItem', id: 'add_article_line_link',
      title: t('view.prints.add_article_line_title') %>
  </div>
  <section id="payments" class="nested_items">
    <h2><%= t 'view.prints.payment' %></h2>
    <table class="summary">
      <thead>
        <tr class="payment_headers">
          <th><%= Payment.human_attribute_name :amount %></th>
          <th><%= Payment.human_attribute_name :paid %></th>
          <th></th>
          <th><%= Payment.human_attribute_name :paid_with %></th>
        </tr>
      </thead>
      <tbody>
        <%= f.fields_for :payments do |p_f| %>
          <tr class="payment">
            <td>
              <div class="nested_item_field">
                <%= p_f.text_field :amount, value: '%.3f' % p_f.object.amount,
                  id: "payment_#{p_f.object.paid_with}_amount",
                  maxlength: 15, size: nil, readonly: true %>
              </div>
            </td>
            <td>
              <div class="nested_item_field">
                <%= p_f.text_field :paid, value: '%.3f' % p_f.object.paid,
                  id: "payment_#{p_f.object.paid_with}_paid",
                  maxlength: 15, size: nil, readonly: p_f.object.credit? %>
              </div>
            </td>
            <td>
              <% if p_f.object.credit? %>
                <div class="nested_item_field">
                  <%= f.password_field :credit_password, value: '', size: nil,
                    maxlength: 255,
                    placeholder: Print.human_attribute_name(:credit_password) %>
                </div>
              <% else %>
                &nbsp;
              <% end %>
            </td>
            <td>
              <%= p_f.object.paid_with_text %>
              <%= p_f.hidden_field :paid_with %>
              <%= p_f.hidden_field :lock_version %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>

  <div class="actions">
    <%= f.hidden_field :order_id %>
    <%= f.hidden_field :lock_version %>
    <%= hidden_field_tag :total_pages, @print.total_pages, id: 'total_pages',
      'data-price-per-one-sided' => Setting.price_per_one_sided_copy,
      'data-price-per-two-sided' => Setting.price_per_two_sided_copy %>
    <%= f.submit nil, id: 'print_submit', title: t('view.prints.print_title') %>
  </div>
<% end %>
<%= javascript_tag 'jQuery(function() { Print.updateTotalPrice(); });' if @print.new_record? %>
<script type="text/javascript">
  Print.cashPrefix = '#payment_<%= Payment::PAID_WITH[:cash] %>';
  Print.creditPrefix = '#payment_<%= Payment::PAID_WITH[:credit] %>';
  Print.printMessage = '<%= t('view.prints.print') %>';
  Print.saveMessage = '<%= t('helpers.submit.create', model: Print.model_name.human) %>';
</script>